#!/usr/bin/env node

// 从标准输入中读取 json，生成 HTML Table 到标准输出

const fs = require('fs')
const yargs = require('yargs')
const JSON5 = require('json5')
const _ = require('lodash')
const generateHTMLTable = require('../lib/generateHTMLTable')

const argv = yargs
  .option('data', {
    alias: 'd',
    description: 'JSON5 格式的数据文件',
    type: 'string'
  })
  .option('schema', {
    alias: 'e',
    description: 'JSON5 格式的 Schema 文件',
    type: 'string'
  })
  .option('attributes', {
    alias: 'a',
    description: 'JSON5 格式的 Attributes 文件',
    type: 'string'
  })
  .version(false)
  .help().alias('help', 'h')
  .strict()
  .coerce('data', function (dataFile) {
    dataFile = dataFile || '/dev/stdin'
    return JSON5.parse(fs.readFileSync(dataFile))
  })
  .coerce('schema', function (schemaFile) {
    if (schemaFile) {
      return JSON5.parse(fs.readFileSync(schemaFile))
    }
  })
  .coerce('attributes', function (attributesFile) {
    if (attributesFile) {
      return JSON5.parse(fs.readFileSync(attributesFile))
    }
  })
  .argv

const keys = ['data', 'schema', 'attributes']
let { data, schema, attributes } = _.pick(argv, keys)
if (_.isNil(schema) 
    && ('data' in data && 'schema' in data) 
    && _.isEmpty(_.difference(Object.keys(data), keys))
) {
  // 从 data 中读取 schema
  schema = data.schema
  attributes = data.attributes
  data = data.data
}

const htmlTable = generateHTMLTable(data, schema, { attributes })
console.log(htmlTable)
